<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # ----------------------------------------------------------------------
    # [보안 설정] video 폴더 접근 제어 (Cookie 인증)
    # 'video_token'이라는 쿠키가 없는 상태로 접근하면 차단합니다.
    # ----------------------------------------------------------------------
    # 1. 요청한 주소가 /video/ 폴더인 경우
    RewriteCond %{REQUEST_URI} ^/video/ [NC]
    # 2. 'video_token' 쿠키가 'access_granted' 값을 가지고 있지 않다면
    RewriteCond %{HTTP_COOKIE} !video_token=access_granted [NC]
    # 3. 차단 (403 Forbidden)
    RewriteRule ^ - [F]

    # [기존 규칙 유지] files 폴더 뷰어 연결
    RewriteRule ^files/(.*)$ /session/view_file.php?file=$1 [QSA,L]
</IfModule>

# ----------------------------------------------------------------------
# 1. 디렉토리 리스팅 비활성화 (보안 필수)
# 파일이 없는 폴더에 접속했을 때 파일 목록이 보이는 것을 방지합니다.
# ----------------------------------------------------------------------
Options -Indexes

# ----------------------------------------------------------------------
# 2. 민감한 파일 및 불필요한 확장자 접근 차단
# .git, .env, .txt(코드포함), .md, .lock, .bak 등의 접근을 막습니다.
# ----------------------------------------------------------------------
<FilesMatch "(?i)\.(git|env|md|bak|old|sql|log|sh|inc|swp|dist|conf|lock|ini)$">
    Require all denied
</FilesMatch>

# ----------------------------------------------------------------------
# 3. 특정 민감 파일명 직접 차단 (예: CODE.txt)
# ----------------------------------------------------------------------
<FilesMatch "(?i)^(CODE\.txt|composer\.json|composer\.lock|gemini\.md)$">
    Require all denied
</FilesMatch>

# ----------------------------------------------------------------------
# 4. 이미지 폴더 내 PHP 실행 차단 (업로드 취약점 방지)
# uploads 폴더 내에 .htaccess를 별도로 두어 아래 내용을 넣는 것을 권장합니다.
# ----------------------------------------------------------------------
# (이 부분은 uploads 폴더 안에 별도의 .htaccess 파일을 만들어 넣으세요)
# <FilesMatch "(?i)\.php$">
#     Require all denied
# </FilesMatch>

# ----------------------------------------------------------------------
# [추가] robots.txt 파일은 예외적으로 접근 허용 (Whitelist)
# 이 부분이 있어야 검색 로봇이 차단 규칙을 읽을 수 있습니다.
# ----------------------------------------------------------------------
<Files "robots.txt">
    Require all granted
</Files>